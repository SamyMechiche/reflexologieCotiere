{% extends 'base.html.twig' %}

{% block title %}Mon Tableau de Bord{% endblock %}

{% block body %}
<div class="dashboard-wrapper" style="max-width: 1000px; margin: 2em auto;">
<a href="{{ path('app_home') }}" class="arrow">&#10229;</a>
    <h1>Bienvenue, {{ user.firstName }} {{ user.lastName }}</h1>
    <hr>
    <section>
        <h2>Mes prochains rendez-vous</h2>
        <div data-controller="calendar" id="user-calendar" style="max-width: 700px; margin-bottom: 2em;"></div>
        <script type="application/json" id="calendar-events-data">{{ calendarEvents|raw }}</script>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const el = document.getElementById('user-calendar');
            if (el && window.FullCalendar) {
                const events = JSON.parse(document.getElementById('calendar-events-data').textContent);
                const calendar = new window.FullCalendar.Calendar(el, {
                    initialView: 'dayGridMonth',
                    events: events
                });
                calendar.render();
            }
        });
        </script>
        <table class="table" style="width:100%; background:#fff; border-radius:8px;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>S√©ance</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
            {% for appt in upcomingAppointments %}
                <tr>
                    <td>{{ appt.appointmentDate|date('d/m/Y H:i') }}</td>
                    <td>{{ appt.session ? appt.session.name : 'S√©ance' }}</td>
                    <td>
                        <form method="post" action="{{ path('app_user_appointment_cancel', {'id': appt.id}) }}" style="display:inline;">
                            <input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ appt.id) }}">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Annuler ce rendez-vous ?');">Annuler</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="3">Aucun rendez-vous √† venir.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </section>
    <section>
        <h2>Mes rendez-vous pass√©s</h2>
        <table class="table" style="width:100%; background:#fff; border-radius:8px;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>S√©ance</th>
                    <th>Facture</th>
                </tr>
            </thead>
            <tbody>
            {% for appt in pastAppointments %}
                <tr>
                    <td>{{ appt.appointmentDate|date('d/m/Y H:i') }}</td>
                    <td>{{ appt.session ? appt.session.name : 'S√©ance' }}</td>
                    <td>
                        {% set invoice = invoices|filter(i => i.appointment.id == appt.id)|first %}
                        {% if invoice %}
                            <a href="/docpdf/{{ invoice.id }}.pdf" download>üìÑ T√©l√©charger</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="3">Aucun rendez-vous pass√©.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </section>
    <section>
        <h2>Messages</h2>
        <div class="messages-list" style="max-height:200px; overflow-y:auto; background:#f9f9f9; padding:1em; border-radius:8px;">
            {% for msg in messages %}
                <div style="margin-bottom:1em;">
                    <strong>{{ msg.subject }}</strong> <span style="color:#888;">({{ msg.sentAt|date('d/m/Y H:i') }})</span><br>
                    {{ msg.content }}
                </div>
            {% else %}
                <div>Aucun message.</div>
            {% endfor %}
        </div>
        <form method="post" action="{{ path('app_message_send') }}" style="margin-top:1em;">
            <input type="text" name="subject" placeholder="Sujet" required style="width:30%; margin-right:1em;">
            <input type="text" name="content" placeholder="Votre message" required style="width:50%; margin-right:1em;">
            <button type="submit">Envoyer</button>
        </form>
    </section>
    <section>
        <h2>Mon profil</h2>
        <ul>
            <li>Email : {{ user.email }}</li>
            <li>T√©l√©phone : {{ user.phoneNumber ?: '-' }}</li>
            <li>Compte cr√©√© le : {{ user.createdAt|date('d/m/Y') }}</li>
        </ul>
    </section>
    <section>
        <h2>Mes avis</h2>
        <div>(√Ä venir : affichage des avis laiss√©s par l'utilisateur)</div>
    </section>
</div>
{% endblock %} 